# **Chapter06 - 교착 상태**

# **[ 📋 목차 ]**
- 교착 상태의 개요
- 교착 상태의 필요조건
- 교착 생태 해결 방법
- 다중 지원과 교착 상태 검출

****

# **[ 🗂️ 정리 ]**
### 📌 교착 상태의 개요
#### ⚙︎ 교착 상태의 정의
2개 이상의 프로세스가 다른 프로세스의 작업이 끝나기만 기다리며 작업을 더 진행하지 못하는 상태를 교착 상태(Dead Lock) 이라고 한다.

```
ex1) 교통 체증으로 차들이 교차로에 가득 차면 경찰관이 교통정리를 해줘야 한다.
ex2) 두 요리사가 기구를 하나씩 독점하고 나누지 않아 서로 음식을 못 만든다.
```

시스템 자원, 공유 변수 혹은 파일, 응용 프로그램 등을 사용할 때 발생할 수 있다.

#### ⚙ 교착 상태의 발생
- 시스템 자원: P1 이 프린터를 할당 받은 상태에서 CD 레코더를 기다리는 P2는 CD 레코더를 할당 받은 상태에서 프린터를 기다리는 상태
  ```
    P1 ----→ CD Recoder
    ↑            |
    |            ↓
  Printer ←----- P2
  ```
- 공유 변수: P1과 P2가 임계구역에 도달하지는 못하고 lock 만 true 로 만들었을 때 서로 while 문을 빠져나가지 못하고 무한 루프를 돌게 되는 교착 상태 발생
  ```
    lock1=true                lock2=true
    while(lock2==true);       while(lock1==true);
        임계구역                    임계구역
    lock1=false               lock2=false         
  ```
- 응용 프로그램: 데이터베이스 일관성을 유지하기 위해 자원을 잠그게 되고, 이 때 교착 상태가 발생한다.(트랜잭션 말하는거 같음)

#### ⚙︎ 자원 할당 그래프(Resource Allocation Graph)
어떤 프로세스가 어떤 자원을 사용하고 있고, 대기중인지 방향 그래프(Directed Graph) 로 표현한 것이다.  
- 자원을 사용하는 경우: 
```
자원 ⎯⎯⎯> 프로세스
```
- 자원을 기다리는 경우: 
```
자원 <----- 프로세스
```

자원은 '사각형', 프로세스는 '원' 으로 표현한다.

[그림6-5] p.296

여러 프로세스가 하나의 자원을 동시에 사용하면 다중 자원(Multiple Resource) 라고 한다.  
그림으로 표현하면 사각형 내부에 작은 동그라미로 그리고 프로세스를 가르킨다.

[그림6-6] p.296

****

### 📌 교착 상태 필요조건
- <b>상호 배제(Mutual Exclusion)</b>: 프로세스에 의해 사용중인 자원은 다른 프로세스와 공유할 수 없는 배타적인 자원이어야 한다.(동시 사용x)
- <b>비선점(Non-Preemption)</b>: 다른 프로세스의 자원을 뺏을 수 없는 비선점 자원이어야 한다.(물고 죽으면 끝)
- <b>점유와 대기(Hold and Wait)</b>: 어떤 자원을 할당받은 상태에서 다른 자원을 대기하는 상태여야 한다.(자원을 물고 다른 자원 대기)
- <b>원형 대기(Circular Wait)</b>: 점유와 대기를 하는 프로세스들이 서로 방해하는 방향이 원을 이루면서 양보하지 않는다.

위 4가지 조건이 충족된다면 교착 상태가 발생하다. (하나라도 만족하지 않으면 발생x)  
자원이 공유도 되지 않으면서, 뺏을 수도 없기 때문에 프로세스들이 무작정 대기하는 상태가 발생하는 것이다.

****

### 📌 교착 상태 해결 방법
- <b>예방(Prevention)</b>: 4가지 필요 조건이 있기 때문에 한 가지 방법만 막아도 교착 생태는 발생하지 않는다.(말로는 쉬움)
  - 상호 배제: 배타적인 자원 삭제(시스템상 모든 자원 공유 가능) 하는 방법이지만 실제로는 시스템상에서 보호 받아야 하는 자원이 존재하며 임계구역이 없어서 발생하는 문제를 고려 해야함
  - 비선점: 모든 자원을 뺏을 수 있도록 설정하는 방법이지만 상호 배제와 마찬가지로 임계구역을 보호하기 위해서 자원을 잠그는데 이러면 뺏을 수 없게되고, 만약 뺏을 수 있다해도
  얼마만큼의 시간동안 사용할지 기준이 모호해서 아사 현상의 원인이 되기도 한다.
  - 점유와 대기: 전부 할당하거나 할당하지 않거나(All or Nothing) 프로세스는 처음 시작과 동시에 필요한 자원을 전부 점유하거나 아니면 반납하는 방법이다. 대신에 상호 배제와 비선점에 
  대한 허용은 하는 방법인데 임계구역으로 보호 받는 자원에 대한 제약을 풀기는 어렵다.
    - 점유와 대기 예방법의 단점
      - 프로세스가 필요한 자원을 전부 자세히 알기 어렵다(추가 자원은?)
      - 자원 활용성이 낮다(언제 사용할지도 모르는 자원을 미리 땡기면 다른 프로세스는?)
      - 많은 자원을 사용하는 프로세스가 불리하다(All or Nothing 이기 때문에 점유 못하면 다 반납하고 다시 시도해야함)
      - 일괄 작업 방식(실시간 처리 방식으로 진행이 어려움 -> 키보드, 마우스)
  - 원형 대기 예방
    - 시스템 자원에 숫자를 부여해서 원형 대기 구조가 만들어지지 않도록 방지한다.
      - ex) 숫자가 적은 자원을 할당받은 후 큰 번호의 자원을 할당 받도록 한다.
      ```
      1번 자원을 받으면 3번 자원을 받을 수 있지만
      3번 자원을 받은 후 1번 자원은 받지 못한다. (받지 못하면 프로세스 강제 종료)
      ```
      - 문제점
        - 사용자 입장에서는 이해할 수 없는 진행이 이루어짐 1번 다음 3번은 되는데 3번 다음 1번은 안되는 상황 발생
        - 시스템 자원에 번호를 붙여야 하는데 기준이 없고, 어떻게 숫자를 부여해도 위와 같은 이해할 수 없는 상황이 발생
- <b>회피(Avoidance)</b>: 교착 상태의 가능성이 있다고 생각되면 자원 할당을 중단 하고 대기 (얼만큼 대기해야 하는지, 교착 상태가 발생 하는지등 실효성 낮음)
  - 교착 상태가 발생하는 상태를 측정해서 해당하는 상태에 도달하기 전까지 자원을 할당하는 방법
  - 시스템 자원의 총 수와 현재 할당된 자원의 량을 기준으로 시스템 안정 상태(Safe State)와 불안정 상태(Unsafe State)로 나누고 안정 상태를 유지하도록 자원을 할당한다.
  ```
  ex) 은행원 알고리즘(Banker's Algorithm): 대출이 가능한 범위 내이면 허용 아니면 거부
  가용 자원의 수: A - 10, B - 30
  프로세스가 수: 12
  
  프로세스가 전부 A 자원을 원하게 되면 12개의 A 자원이 필요하기 때문에 교착 상태가 발생할 수 있기 
  떄문에 최대 가용 가능한 프로세스는 10개라고 볼 수 있다. (최악을 상정하기 때문ㅇ)
  ```
  - 문제점
    - 프로세스가 자신이 사용할 자원을 사전에 모두 알고 있어야 한다.
    - 시스템 전체 자원 수가 고정적이어야 한다.
      - 실제로는 일시적으로 고장이나, 새로운 자원이 추가되는 일이 빈번하다.
    - 자원이 낭비
      - 시스템 자원이 놀고 있는데도 불구하고 모든 자원을 사용하지 못한다.
      - 위의 예시를 보면 총 40개의 자원이 있는데도 12개를 요구하는 프로세스에게 10개 밖에 내주지 못한다.
- <b>검출(Detection)</b>: 자원 할당 그래프를 모니터링 하면서 발생하면 회복 단계로 넘어가는 것
    - 예방은 어렵기 때문에 검출이 가장 현실적인 방법이다.
    - 타임 아웃을 이용한 교착 상태 검출
      - 문제점
        - 의도치 않은 동작 발생: 교착 상태가 아닌 작업이 길어져서 타임아웃이 걸려도 프로세스가 종료되는 문제가 발생한다.
        - 모든 시스템에 적용 불가능: 분산 데이터베이스의 경우 시스템이 나뉘어 네트워크로 연결되어 있기 때문에 네트워크 문제인지 교착 상태인지, 작업 시간이 길어지는 건지
        구분이 불가능 하다.
    - 문제점에도 불구하고 OS 와 DB 는 검출 하는 방법을 선호한다.(왜?)
      - 그 이유는 자원 할당 그래프로 교착 상태를 찾는 방법은 구현이 어려움 
      - 가벼운 교착 상태 검출: 타임아웃 ex) 윈도우 응답이 없어 종료합니다. (alert)
        - 타임아웃시 데이터베이스의 경우 체크포인트(Check Point)와 롤백(Rollback) 을 사용해서 데이터 일관성을 지킨다.
        - 체크포인트의 경우 현재 시스템 상태가 하드디스크에 저장 되는데 이렇게 저장된 데이터를 스냅샷(Snap shot) 이라 한다.
      - 무거운 교착 상태 검출: 자원 할당 그래프
        - [그림6-22] p.315
        - 교착 상태가 있는 그래프를 보면 표시된 곳이 순환 참조를 만들어내는 곳이다.
        - 하지만 어려운 점은 사이클이 생긴다고 무조건 교착 상태로 판단할 수 없다. [심화학습]
      - 장점: 프로세스의 작업 방식을 제한하지 않으면서 교착 상태를 정확하게 진단 가능
      - 단점: 그래프 유지, 갱신, 사이클 검사하는 작업으로 인해서 오버헤드 발생
- <b>회복(Recovery)</b>: 교착 상태 발생 후 조치(교착 상태를 유발한 프로세스 강제 종료)
  - 교착 상태 일으킨 모든 프로세스 종료
    - 다시 또 동시에 작업을 시작한다면 다시 교착 상태를 일으킬 가능성이 높다.
    - 순차적으로 탐색하며 문제 원인이 된 프로세스를 찾는게 중요하다.
  - 교착 상태를 일으킨 프로세스 중 하나를 골라 순서대로 종료
    - 하나씩 순서대로 종료하며 교착상태의 원인이 된 프로세스 찾는 방법
      - 우선순위가 낮은 프로세스 순서로 종료
      - 우선순위가 같은경우 작업 시간이 짧은 프로세스 종료
      - 위 두 조건이 동일한 경우 자원을 많이 사용하는 프로세스 먼저 종료
  
순차적으로 종료하면서 시스템을 복구하는 작업을 해야 하며, 명령어가 실행될 때마다 체크포인트를 만들어서 가장
최근의 검사 시점으로 돌아가는 식으로 한다.  
하지만 작업량이 많고, 시스템 부하를 주기 때문에 체크포인트를 무분별하게는 사용할 수 없다.

****

### 📌 [심화학습] 다중 자원과 교착 상태 검출
자원 할당 그래프에서 교착상태로 판단할 수 있는 상황은 하나의 프로세스가 하나의 자원을 사용할 때다.  
따라서 다중 자원을 사용하는 프로세스가 있다면 더 복잡한 검출 방법을 거친다.

#### ⚙︎ 다중 자원과 사이클
```
  P1 ----→ R2
  ↑        |
  |        ↓
  R1 ⎯⎯→ P2
  
  R1은 다중 자원으로 여러 프로세스가 동시에 사용 가능  
```

위 그림이 P2가 R1, R2 를 사용중이며, P1이 R2를 대기하는 중이며 그래프 방향을 보면 순환되는 그래프가 그려지지만 P2가 자원을 
사용하고 반환하는 상황이 되면 교착 상태가 아님을 알 수 있다.
  
따라서 순환 그래프라고 모두 교착 상태는 아니다.

#### ⚙ 대기 그래프(Wait for Graph)와 그래프 감소(Graph Reduction)
- 대기 그래프: 자원 할당 그래프에서 프로세스와 프로세스 간에 대기 관계만 나타낸 그래프
- 그래프 감소: 대기 그래프에서 작업이 끝날 가능성이 있는 프로세스의 화살표와 관련 프로세스의 화살표를 연속적으로 지워 나가는 작업

[그림 6-24] p.319

대기 그래프를 만들고 그래프 감소 순서를 표시해 감소 결과 사이클이 남아있지 않다면 교착 상태는 발생하지 않는다.

[그림 6-25]

작업을 끝낼 수 있는 프로세스가 없기 때문에 교착 상태로 간주한다.